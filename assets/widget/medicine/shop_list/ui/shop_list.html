<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>mCollection</title>
    <meta name="viewport" content="target-densitydpi=device-dpi,width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../../../static/mdui/css/mdui.min.css">
    <link rel="stylesheet" href="../../../static/mCheap/css/mCommon.css">
    <style>
        *{
            font-family: "Microsoft YaHei";
        }
        body{
            background-color: #E6EAE8;
        }
        .header-box{
            background-color: #3BA15C;
            padding: 0;
        }
        .header{
            width: 100%;
            height: 100%;
            position: relative;
        }
        .back{
            padding-right: 1rem;
            padding-left: 1rem;
            padding-top: 0.75rem;
            position: fixed;
            z-index: 100;
        }
        .back img{
            width:auto;
            height: 1.25rem;
        }
        .title{
            text-align: center;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0px;
            line-height: 2.75rem;
            color: #FFFFFF;
        }
        /*=============市场头===================*/

        .price-sort{
            padding-left: 1rem;
            color: #EA4828;
        }
        .price-info{
            padding: 0 1rem 0 1rem;
        }
        .market{
            margin-top: 2.75rem;
            width: 100%;
            padding: 1rem;
            background-color: white;
            border-bottom: 1px solid #cccccc;
        }
        .market-img{
            width: 7rem;
            height: 5rem;
            border-radius: 0.3rem;
        }
        .market-title{
            display: inline-block;
            margin-left: 1rem;
        }
        .market-describe{
            width: auto;
        }
        .set-like{
            line-height: 100%;;
            /*border:1px solid #F57F20;*/
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem 0.2rem 0.5rem;
            border-radius: 1rem;
            display: inline-block;
            float: right;
            /*color: #F57F20;*/
        }
        .lists-box{
            width: 100%;
            height: 100%;
        }
        /*=========================================*/

        /*=============产品展示===================*/
        .product-show{
            background-color: white;
            overflow: auto;
        }
        /*========================list===========================*/
        .img-box{
            padding-left: 1rem;
            width: 7rem;
            height: 5rem;
        }
        .list-box{
            position: relative;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #cccccc;
            /*border-top: 1px solid #cccccc;*/
        }
        .market-img-box{
            width: 100%;
            height: 100%;
        }
        .market-list-name{
            font-weight: 600;
        }
        .address{
            white-space:nowrap;
            width: 10rem;
            overflow: auto;
            font-size: 0.8rem;
            padding-left: 1rem;
            background: url("../image/dis.png")no-repeat left center;
            background-size: 0.8rem auto;
        }
        .market-detail{
            padding-left: 1rem;
        }
        .standard,.factory{
            font-size: 0.8rem;
            color: #7E7E7E;
            overflow: hidden;
            white-space:nowrap;
            padding: 0 0.5rem 0 1rem;
        }
        .store-price{
            position: absolute;
            bottom: 10%;
            right: 5%;
            font-weight: 600;
            color: #6BB250;
        }
        .time{
            font-size: 0.8rem;
            padding-left: 1rem;
            background: url("../image/time.png")no-repeat left center;
            background-size: 0.8rem auto;
        }
        .price{
            font-size: 1.2rem;
            font-weight: 600;
            color: #6BB250;
        }
        .gz{
            width: 1.2rem;
            height: 1.2rem;
        }
        /*.market-box{*/
            /*padding-bottom: 2rem;*/
        /*}*/
        /*=========================list==========================*/
        /*======筛选======*/
        .top-choose{
            z-index: 100;
            position: fixed;
            top: 1%;
            right: 2%;
            background: url("../image/shaixuan.png")no-repeat center;
            background-size: 1.5rem 1.5rem;
            margin-right: 0.5rem;
            margin-left: 0.5rem;
            width: 1.5rem;
            height: 2rem;
        }
        /*======筛选======*/
        .mc{
            position: fixed;
            background: rgba(0,0,0,0.3);
            width:100%;
            height:100%;
            z-index:2;
            display: none;
        }
        .sx-box{
            width: 100%;
            margin-top: 2.75rem;
            background-color: white;
            border-bottom: 1px solid #CCCCCC;
        }
        .sx-left{
            background: url("../image/down.png")no-repeat 70%;
            background-size: 0.7rem 0.5rem;
            border-right: 1px solid #CCCCCC;
            width: 50%;
            text-align: center;
            padding: 0.5rem;
        }
        .sx-left-on{
            background: url("../image/lvup.png")no-repeat 70%;
            background-size: 0.7rem 0.5rem;
            border-right: 1px solid #CCCCCC;
            width: 50%;
            color: green;
            text-align: center;
            padding: 0.5rem;
        }
        .sx-right{
            background: url("../image/down.png")no-repeat 70%;
            background-size: 0.7rem 0.5rem;
            width: 50%;
            text-align: center;
            padding: 0.5rem;
        }
        .my-item{
            padding: 0.5rem 0.5rem 0.5rem 1rem;
            background-color: white;
            border-bottom: 1px solid #CCCCCC;
        }
        .px-my-item{
            color: black;
            padding: 0.5rem 0.5rem 0.5rem 1rem;
            background-color: white;
            border-bottom: 1px solid #CCCCCC;
            border-right: 1px solid #CCCCCC;
        }
        .px-my-item-on{
            color: green;
            padding: 0.5rem 0.5rem 0.5rem 1rem;
            background-color: white;
            border-bottom: 1px solid #CCCCCC;
            border-right: 1px solid #CCCCCC;
        }
        .my-item-choose{
            position: relative;
            height: 3rem;
            background-color: white;
        }
        .my-item-on{
            background: url("../image/greenright.png")no-repeat 90%;
            background-size: 1.2rem 0.8rem;
            color: green;
            padding: 0.5rem 0.5rem 0.5rem 1rem;
            background-color: white;
            border-bottom: 1px solid #CCCCCC;
        }
        .sx-right-on{
            background: url("../image/lvup.png")no-repeat 70%;
            background-size: 0.7rem 0.5rem;
            width: 50%;
            color: green;
            text-align: center;
            padding: 0.5rem;
        }
        .distance{/*my*/
            display: none;
        }
        .distance-item{
            border-bottom: 1px solid #CCCCCC;
            padding: 0.5rem 0.5rem 0.5rem 1rem;
            background-color: white;
        }
        .distance-item-on{
            background: url("../image/greenright.png")no-repeat 90%;
            background-size: 1.2rem 0.8rem;
            padding: 0.5rem 0.5rem 0.5rem 1rem;
            background-color: white;
            color: green;
            border-bottom: 1px solid #CCCCCC;
        }
        .reset{
            position: absolute;
            left: 5%;
            top:15%;
            padding: 0.25rem;
            border: 1px solid #CCCCCC;
        }
        .sure{
            position: absolute;
            right: 5%;
            top:15%;
            padding: 0.25rem;
            border: 1px solid #CCCCCC;
        }

        /*======筛选======*/

        /*=========每个list=======*/
        .start-box>img{
            height: 1rem;
            width: 1rem;
        }
        .far{
            font-size: 0.8rem;
            position: absolute;
            top:10%;
            right: 5%;
        }
        .list-set-like{
            display: none;
        }
        .list-set-like>img{
            position: absolute;
            width: 1.2rem;
            height: 1.2rem;
            bottom:45%;
            right: 5%;
        }
        .no-data{
            height: 3rem;
            text-align: center;
            line-height: 3rem;
            border-bottom: 1px solid #CCCCCC;
        }
    </style>
</head>
<body>
<div class="mc">
    <div class="mdui-box sx-box">
        <div class="sx-l sx-left">距离</div>
        <div class="sx-r sx-right">筛选</div>
    </div>
    <div class="distance">
        <div class="distance-item">附近</div>
        <div class="distance-item">1km</div>
        <div class="distance-item">2km</div>
        <div class="distance-item">3km</div>
        <div class="distance-item">4km</div>
        <div class="distance-item">全城</div>
    </div>
    <div class="my">
        <div class="my-choose">
            <div class="my-item-on">常用地址</div>
            <div class="my-item">我关注的药店</div>
        </div>
        <div class="mdui-box px">
            <div class="px-my-item mdui-box-flex-1">价格升序</div>
            <div class="px-my-item mdui-box-flex-1">价格降序</div>
            <div class="px-my-item mdui-box-flex-1">距离升序</div>
            <div class="px-my-item mdui-box-flex-1">距离降序</div>
        </div>
        <div class="my-item-choose mdui-box">
            <div class="reset">重置</div>
            <div class="sure">确定</div>
        </div>
    </div>
</div>
<div class="header-box mdui-bar mdui-bar-nav">
    <div class="header">
        <div class="back mdui-action-back"><img src="../image/back.png"></div>
        <div class="title">药店信息</div>
        <div class="top-choose"></div>
    </div>
</div>
<div class="mdui-box mdui-box-ver lists-box">
    <div class="market">
        <div class="mdui-box">
            <div class="market-img-div">
                <!--<img src="../image/market_hongxinglu.png" class="market-img"/>-->
            </div>
            <div class="market-describe mdui-box-flex-1">
                <div>
                        <span class="market-title">
                            <strong class="market-name">产品名字</strong>
                        </span>
                    <div class="set-like">
                        <img src="../image/dislike.png" class="gz"/>
                    </div>
                </div>
                <div class="standard">规格:1盒</div>
                <div class="factory">长沙ldjfdlksjfljldsajfljsdljflkadsf</div>
                <div class="mdui-box price-info">
                    <div class="price">$3.66</div>
                    <div class="price-sort">全市平均价</div>
                </div>
            </div>
        </div>
    </div>

    <div class="product-show mdui-box-flex-1" id="list">


        <!--<div class="mdui-box list-box">-->
            <!--<div class="far">14km</div>-->
            <!--<div class="img-box">-->
                <!--<img src="../image/market_hongxinglu.png" class="market-img-box"/>-->
            <!--</div>-->
            <!--<div class="market-detail">-->
                <!--<div class="market-list-name">第一个</div>-->
                <!--<div class="start-box">-->
                    <!--<img src="../image/star.png"/>-->
                    <!--<img src="../image/star.png"/>-->
                    <!--<img src="../image/star.png"/>-->
                    <!--<img src="../image/star.png"/>-->
                    <!--<img src="../image/star.png"/>-->
                <!--</div>-->
                <!--<div class="address">地址</div>-->
                <!--<div class="time">aaa</div>-->
                <!--<div class="store-price">$3.66</div>-->
                <!--<div class="list-set-like">-->
                    <!--<img src="../image/dislike.png"/>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->

    </div>
</div>




<!--页面-->
<script src="../../../static/mdui/js/mdui.js"></script>
<script src="../../../static/mCheap/js/mCheap.config.js"></script>
<script src="../../../server.js"></script>
<script src="../js/choose.js"></script>
<script src="../../public.js"></script>
<script src="../../../static/mCheap/js/scroll.js"></script>
<script>
    var obj={};//保存药品信息
    var requestFlag=true;//请求开关
    var moreObj={distance:'',focus:'',ppiont:'',flag:'',sign:'',pageNum:1};
    $.uexWindowReady(function(){
        //加载更多
        var option = {id:"list",funs:{after:function(){
            if(requestFlag){
                moreObj.pageNum=moreObj.pageNum+1;
                var distance=moreObj.distance;
                var focus=moreObj.focus;
                var ppiont=moreObj.ppiont;
                var flag=moreObj.flag;
                var sign=moreObj.sign;
                requestData(distance,focus,ppiont,flag,sign,moreObj.pageNum);
            }else{
                $.toast('没有更多了!');
            }
        }}};
        $.initScroll(option);

        setMedicineData();
        requestData('','','','','',moreObj.pageNum,'yes');
    });

    function requestData(distance,focus,ppiont,flag,sign,pageNum,recordMark){
        $.request({
            urlType:'nearPharmacyPrice',
            data:{
                "access_token": $.getStorage('access_token'),
                log: $.getStorage('log'),
                lat:$.getStorage('lat'),
                id:obj.id?obj.id:'',
                distance :distance?distance:'',
                focusCs:focus?focus:'',
                flag:flag?flag:'',
                purchasePointCs:ppiont?ppiont:'',
                sign:sign?sign:'',
                pageSize:'10',
                page:pageNum,
                name:obj.drugName, //记录药品名称
                comeFlag:'01', //访问来源标志:01app,02微信,03门户
                recordMark:recordMark||'no', //记录标志,
                saveParam:'4' //记录所属模块标志
            }
        },function(json){
            if(json.success) {
//                alert(JSON.stringify(json)+"附近药店");
                var data=json.data;
                if(data.length){
                    setThisData(data);
                }else{
                    if(pageNum==1){
                        setThisData(data);
                    }else{
                        $.toast('没有更多了!');
                        requestFlag=false;
                    }
                }
            }
            else {
                alert('网络错误');
            }
        });
    }

    //筛选点击确定后
    $('.sure').on('tap',function(){
        var far= $('.sx-l').html(),ppiont,focus,pxname,flag,sign;
        far = getDistance(far);
        moreObj.distance=far;
        if($('.my-choose>div:first-child').hasClass('my-item-on')){
            ppiont ='1';
            moreObj.ppiont=ppiont;
        }else{
            ppiont ='';
            moreObj.ppiont=ppiont;
        }
        if($('.my-choose>div:last-child').hasClass('my-item-on')){
            focus = '1';
            moreObj.focus=focus;
        }else{
            focus = '';
            moreObj.focus=focus;
        }
        $('.px>div').each(function(){
            if($(this).hasClass('px-my-item-on')){
                pxname = $(this).html();
            }
        });
        var px = setPx(pxname)?setPx(pxname):'';
        flag =px.substring(0,2)?px.substring(0,2):'';
        moreObj.flag=flag;
        sign =px.substring(px.length,px.length-1)?px.substring(px.length,px.length-1):'';
        moreObj.sign=sign;
        moreObj.pageNum=1;
        $('#list').html('');
        requestData(far,focus,ppiont,flag,sign,moreObj.pageNum);
        $('.mc').hide();
        $('.top-choose').removeClass('top-choose-on');
    });

    //设置药品数据
    function setMedicineData(){
        var pageData=$.pageParam;
        var medicineData=$.strToJson(pageData);
        obj.drugName=medicineData.drugName;
        $('.market-name').html(medicineData.drugName);
        $('.standard').html(medicineData.standard);
        $('.factory').html(medicineData.factory);
        $('.price').html(medicineData.price);
        obj.id=medicineData.id;
        obj.midName=medicineData.midName;
        obj.tinyName=medicineData.tinyName;
        obj.picture=medicineData.picture;
        var img='<img src="'+ $.serverSettings.serverPath+'/mobile/mcheap/medicineAction!getMedicinePicture.do?access_token='+ $.getStorage('access_token')+'&url='+obj.picture+'" class="market-img"/>';
        $('.market-img-div').html(img);
        if(parseInt(medicineData.focus)){
            $('.gz').attr('src','../image/like.png');
        }
    }


    //点击单个药店列表
    $('.product-show').on('tap','.list-box',function(){
        //alert(222);
        $.openWin({
            name:"shop_drug_list",
            animId : 2,
            url:'wgtroot://medicine/medicine_shop/ui/shop_drug_list.html',
            pageParam: {
                ypLsh:obj.id,
                ypName:obj.drugName,
                lsh:$(this).data('lsh'),
                storeStar:$(this).data('star'),
                storeName:$(this).find('.market-list-name').html(),
                storeAddress:$(this).find('.address').html(),
                storeYysj:$(this).find('.time').html(),
                tiaoshu:$(this).data('tiaoshu'),
                focus:$(this).data('focus'),
                range:$(this).data('range'),
                midName:obj.midName,
                tinyName:obj.tinyName,
                picture:$(this).data('picture'),
                log:$(this).data('log'),
                lat:$(this).data('lat')
            }
        });
    });

    //设置关注药店
    $('.market').on('tap','.set-like',function(){
        var srcImg =$('.gz').attr('src'),medicine;
        medicine={
            id:obj.id,//药品流水号,
            namemark:$('.market-name').html(),//药品名称,
            specification:$('.standard').html(),//药品规格,
            factory:$('.factory').html()//药品生产商
        };
        if(srcImg=='../image/dislike.png'){
            $.request({
                urlType:'addFocusMedicine',
                data:{
                    "access_token": $.getStorage('access_token'),
                     medicine:JSON.stringify(medicine)
                }
            },function(json){
                if(json.success) {
                    $.toast(json.message);
                    $('.gz').attr('src','../image/like.png')
                }
                else {
                    alert('网络错误')
                }
            });
        }else{
            $.request({
                urlType:'delFocusMedicine',
                data:{
                    "access_token": $.getStorage('access_token'),
                    id :obj.id//药品流水号
                }
            },function(json){
                if(json.success) {
                    $.toast(json.message);
                    $('.gz').attr('src','../image/dislike.png')
                }
                else {
                    alert('网络错误')
                }
            });
        }
    });

    $('.px').on('tap','.mdui-box-flex-1',function(){
        $('.px>div').each(function(){
            $(this).removeClass('px-my-item-on');
        });
        $(this).addClass('px-my-item-on');
    });

    //设置排序
    function setPx(px){
        switch(px){
            case '价格升序':return 'jgu';
                break;
            case '价格降序':return 'jgd';
                break;
            case '距离升序':return 'jlu';
                break;
            case '距离降序':return 'jld';
                break;
        }
    }
</script>
</body>
</html>