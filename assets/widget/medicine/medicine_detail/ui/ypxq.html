<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>mCollection</title>
    <meta name="viewport" content="target-densitydpi=device-dpi,width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../../../static/mdui/css/mdui.min.css">
    <link rel="stylesheet" href="../../../static/mCheap/css/mCommon.css">
    <style>
        *{
            font-family: "Microsoft YaHei";
        }
        body{
            background-color: #E6EAE8;
            padding-top: 2.75rem;

        }
        .header-box{
            background-color: #3BA15C;
            padding: 0;
        }
        .header{
            width: 100%;
            height: 100%;
            position: relative;
        }
        .back{
            padding-right: 1rem;
            padding-left: 1rem;
            padding-top: 0.75rem;
            position: absolute;
            z-index: 100;
        }
        .back img{
            width:auto;
            height: 1.25rem;
        }
        .title{
            text-align: center;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0px;
            line-height: 2.75rem;
            color: #FFFFFF;
        }
        .top{
            padding:0 1rem 1rem 1rem;
            background-color: #ffffff;
        }
        .top-img{
            width: 5rem;
        }
        .top-img>img{
            width: 5rem;
            height: auto;
            border-radius: 0.2rem;
        }
        .top-title{
            margin-top: 1rem;
            padding-left: 1rem;
            color: #000000;
        }
        .product-name{
            font-weight: 600;
        }
        .top-market,.standard{
            font-size: 0.8rem;
            margin-left: 1rem;
        }
        .top-price{
            margin-left: 1rem;
            color: #3BA15C;
            font-size: 1.2rem;
        }
        .content{
            margin-top: 1rem;
            background-color: #ffffff;
        }
        .top-comment{
            line-height: 100%;
            padding: 0.2rem 0.5rem 0.2rem 0.5rem;
            border-radius: 1rem;
            border: 1px solid #F57F20;
            float: right;
            color: #F57F20;
            font-size: 0.8rem;
        }
        .add{
            float: right;
            width: 1.2rem;
            height: 1.2rem;
            background: url("../image/add.png") no-repeat center;
            background-size: 1.2rem;
        }
        .line-one{
            height: 4.5rem;
            padding: 1rem;
            position: relative;
        }
        .commentator-price{
            position: absolute;
            right: 5%;
            top: 35%;
            color: #3BA15C;
        }
        .commentator-num{
            color: #3BA15C;
        }
        .div-img{
            float: left;
        }
        .comment-list{
            border-bottom: 1px solid #B0B0B0;
        }
        .commentator{
            color: black;
            float: left;
            margin-left: 1rem;
            margin-top: 0.75rem;
        }
        .commentator-me{
            color: #3BA15C;
            float: left;
            margin-left: 1rem;
            margin-top: 0.75rem;
        }
        .head-img{
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 1.25rem;
        }
        .comment-detail{
            color:black;
            padding-left: 1rem;
        }
        .second-title{
            width: 100%;
            border-bottom: 1px solid #B0B0B0;
        }
        .comment-time{
            font-size: 0.9rem;
            padding-top: 0.2rem;
            padding-left: 1rem;
            padding-bottom: 1rem;
        }

        .second-title:after{
            display: table;
            clear: both;
            content: '';
        }
        .cj-imgs,.comment-xz,.gzbj{
            text-align: center;
            padding-top: 1rem;
            padding-bottom: 0.8rem;
        }
        .choose{
            color:#3BA15C;
            text-align: center;
            padding-top: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 0.2rem solid #3BA15C;
        }
        .comment-lists{
            display: none;
        }
        .pzxq-content{
            display: none;
        }
        .xq-div{
            padding: 1rem;
        }
        /*==================评论蒙层=======================*/

        .vertical{
            margin-top: 0.8rem;
            color: #666666;
        }
        .xq-title{
            color: green;
        }
        .xq-box{
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .fbpl{
            width: 100%;
            height: 3rem;
            text-align: center;
            line-height: 3rem;
            color: white;
        }
        .qd{
            z-index: 120;
            width: 100%;
            height: 3rem;
            text-align: center;
            line-height: 3rem;
            color: white;
        }
        .mask{
            background-color:#cccccc;
            display: none;
            height:100%;
            width:100%;
            position:fixed;
            top:2.8rem;
            z-index:200;
        }
        .contents{
            display: none;
            background-color:#fff;
            left: 0;
            right:0;
            top: 55%;
            z-index: 1000;
            bottom: -10em;
            height: 10rem;
            width: 100%;
            position: fixed;
            text-align: center;
            overflow:auto;
        }
        .price-box{
            padding: 1rem;
            color: black;
        }
        #price-input{
            background-color: #F2F2F2;
            font-size: 1rem;
            width: 4.5rem;
            height: 2rem;
            margin-bottom: 0rem;
        }
        .input-box{
            padding: 0.5rem 0 0.5rem 0.5rem;
        }
        .pro-price{
            border-top: 1px solid #CCCCCC;
            border-bottom: 1px solid #CCCCCC;
            z-index: 250;
            width: 100%;
            height: 3rem;
            margin-top: 10rem;
            background-color: white;
        }
        .unit{
            padding: 1rem 1rem 1rem 0;
            color: black;
        }
        .get-in{
            z-index: 100;
            font-weight: 600;
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 3rem;
            background-color:  #3BA15C;
            color: white;
            line-height: 3rem;
            text-align: center;
        }
        .set-price{
            z-index: 110;
            font-weight: 600;
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 3rem;
            background-color:  #3BA15C;
            color: white;
            line-height: 3rem;
            text-align: center;
            display: none;
        }
        #con-4{
            padding-bottom: 3rem;
        }


        /*==================图片框=======================*/
        .img{
            z-index: 250;
        }
        .person-img{
            width: 25%;
            height: 6rem;
            border: 1px solid white;
            text-align: center;
        }
        .pic-img{
            width: 100%;
            height: 100%;
        }


        /*==================图片框=======================*/
        /*==================图片框=======================*/
        .img{
            z-index: 250;
            overflow-x:auto;
        }
        .person-img{
            width: 5rem;
            height: 6rem;
            border: 1px solid white;
            text-align: center;
        }
        .pic-img{
            width: 5rem;
            height: 6rem;
        }
        .picture-box{
            height: 6rem;
        }
        .picture-box>img{
            width: 5rem;
            height: 100%;
            margin-left: 0.2rem;
            margin-right: 0.2rem;
        }
        .close-mc{
            float: right;
            margin-right: 1rem;
            margin-top: 1rem;
            color: white;
            padding: 0.25rem 0.5rem 0.25rem 0.5rem;
            border-radius: 1rem;
            border: 1px solid white;
        }


        /*==================图片框=======================*/

        /*上传中显示蒙层 -->*/
        .upload-mc{
            width:100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            position:fixed;
            z-index:999;
            display: none;
        }
        .progress_bars{
            width: 80%;
            height: 1rem;
            border-radius: 0.5rem;
            margin-left: 10%;
            margin-top: 5rem;
            border: 1px solid white;
        }
        .progress_bar{
            width: 0%;
            height: 1rem;
            border-radius: 0.5rem;
            background-color: red;
        }
        .progress{
            color: red;
            text-align:center;
            width: 100%;
            margin-top: 0.5rem;
        }
        .pictures-box>img{
            width: 5rem;
            height: 5rem;
            margin-left: 0.2rem;
            margin-right: 0.2rem;
        }
    </style>
</head>
<body>
<div class="upload-mc">
    <div class="progress_bars">
        <div class="progress_bar"></div>
    </div>
    <div class="progress">loading</div>
</div>


<div>
    <div class="header-box mdui-bar mdui-bar-nav">
        <div class="header">
            <div class="back mdui-action-back"><img src="../image/back.png"></div>
            <div class="title">药品详情</div>
        </div>
    </div>
    <div class="top mdui-box">
        <div class="top-img"></div>
        <div class="mdui-box-flex-1">
            <div class="top-title"><span class="product-name"></span><div class="top-comment">评论</div></div>
            <div class="top-market"></div>
            <div class="standard"></div>
            <div class="top-price"></div>
        </div>
    </div>
    <div class="content">
        <!--==========================只有两个tab================================-->
        <div class="second-title mdui-box">
            <div class="comment-xz mdui-box-flex-1">药品详情</div>
            <div class="vertical">|</div>
            <div class="cj-imgs mdui-box-flex-1">评论 &nbsp;</div>
            <div class="vertical">|</div>
            <div class="gzbj mdui-box-flex-1">公众报价 </div>
        </div>
        <div class="classify-content">

            <!--评论-->
            <div id="con-2" class="comment-lists">
                <div class="comment-list">
                    <div class="line-one">
                    <div class="div-img"><img class="head-img" src="../image/head.jpg"/></div>
                    <div class="commentator">张笑笑</div>
                    </div>
                    <div class="comment-detail">蔬菜很新鲜，价格很便宜</div>
                    <div class="comment-time">2016-08-23 09:02</div>
                </div>
            </div>

            <!--药品详情-->
            <div id="con-0" class="pzxq-content">
                <div class="xq-div">
                    <div class="xq-box">
                        <span class="xq-title">组成成分:</span>
                        <span class="element"></span>
                    </div>
                    <div class="xq-box">
                        <span class="xq-title">药品性状:</span>
                        <span class="appearance"></span>
                    </div>
                    <div class="xq-box">
                        <span class="xq-title">功能主治:</span>
                        <span class="functions"></span>
                    </div>
                    <div class="xq-box">
                        <span class="xq-title">药品用量:</span>
                        <span class="dosage"></span>
                    </div>
                    <div class="xq-box">
                        <span class="xq-title">注意事项:</span>
                        <span class="attentions"></span>
                    </div>
                    <div class="xq-box">
                        <span class="xq-title">药理反应:</span>
                        <span class="adversereactions"></span>
                    </div>
                    <div class="xq-box">
                        <span class="xq-title">储存方式:</span>
                        <span class="store"></span>
                    </div>
                    <div class="xq-box">
                        <span class="xq-title">保质期:</span>
                        <span class="validitydate"></span>
                    </div>
                </div>
            </div>

            <!--公众报价-->
            <div id="con-4">
                <div class="con-4-content" id="list">

                    <!--<div class="comment-list">-->
                        <!--<div class="line-one">-->
                            <!--<div class="div-img"><img class="head-img" src="../image/t01f45d14a61adc12ab.jpg"/></div>-->
                            <!--<div class="commentator">张笑笑</div>-->
                        <!--</div>-->
                        <!--<div class="comment-detail">报价: <span class="bj">35</span> 元</div>-->
                        <!--<div class="pictures-box">-->
                            <!--<img src="../image/add_pic.png">-->
                            <!--<img src="../image/add_pic.png">-->
                            <!--<img src="../image/add_pic.png">-->
                        <!--</div>-->
                        <!--<div class="comment-time">2016-08-23 09:02</div>-->
                    <!--</div>-->

                </div>
                <div class="get-in">我要报价</div>
            </div>

        </div>
    </div>

    <!--评论-->
    <div class="mask">
        <div class="close-mc">close</div>
        <div class="mdui-box pro-price">
            <div class="price-box mdui-box-flex-5">请输入价格：</div>
            <div class="input-box mdui-box-flex-1">
                <input type="number" id="price-input"/>
            </div>
            <div class="unit mdui-box-flex-1">元</div>
        </div>
        <div class="img mdui-box">
            <div class="picture-box"></div>
            <div class="person-img">
                <a href="#picture">
                    <img id="img-1" class="pic-img" src="../image/add_pic.png">
                </a>
            </div>
        </div>
        <div class="set-price">确定</div>
    </div>
</div>

<!-- 点击照片显示蒙层 -->
<div id="picture" class="mdui-popover mdui-popover-action mdui-popover-bottom">
    <ul class="mdui-table-view"><!--菜单列表-->
        <li class="mdui-table-view-cell photo">
            <a href="#">拍照</a>
        </li>
        <li class="mdui-table-view-cell album">
            <a href="#">从相册选取</a>
        </li>
    </ul>
    <ul class="mdui-table-view">
        <li class="mdui-table-view-cell">
            <a href="#picture"><b>取消</b></a>
        </li>
    </ul>
</div>


<!--页面-->
<script src="../../../static/mdui/js/mdui.min.js"></script>
<script src="../../../static/mCheap/js/mCheap.config.js"></script>
<script src="../../../server.js"></script>
<script src="../../../public.js"></script>
<script src="../../../static/mCheap/js/scroll.js"></script>
<script>
    var cltpro01id;//保存产品id
    var proName;//保存产品名称
    var lsh;//保存市场流水号
    var drugOrigin;//厂商
    var flag;//控制开关
    var standard='';//规格
    var url;//产品图片
    var storeName;//保存药店名字
    var pNum=1;//控制上传图片的个数
    var pageNum=1;//分页的时候用的
    $.uexWindowReady(function(){
        //下拉加载更多
        var option = {id:"list",funs:{after:function(){
            pageNum=pageNum+1;
            medicineQueryUserPrice();
        }}};
        $.initScroll(option);

        setTitleData();
        setContentData();
        medicineQueryUserPrice();
        $('.comment-xz').trigger('tap');
    });

    //设置标题数据
    function setTitleData(){
        var pageData=$.pageParam;
        cltpro01id = $.strToJson(pageData).id;
        storeName=$.strToJson(pageData).storeName;
        proName = $.strToJson(pageData).drugName;
        drugOrigin = $.strToJson(pageData).drugOrigin.substring(16);
        standard = $.strToJson(pageData).standard||'';
        $('.product-name').html(proName);
        $('.top-market').html($.strToJson(pageData).drugOrigin);
        $('.standard').html(standard);
        $('.top-price').html($.strToJson(pageData).drugPrice);
        lsh = $.strToJson(pageData).lsh;
        url=$.strToJson(pageData).picture;
        var img='<img src="'+ $.serverSettings.serverPath+'/mobile/mcheap/medicineAction!getMedicinePicture.do?access_token='+ $.getStorage('access_token')+'&url='+url+'"/>';
        $('.top-img').html(img);
    }

    //获取内容数据
    function setContentData(){
        $.request({
            urlType:'checkDrugstore',
            data:{
                "access_token": $.getStorage('access_token'),
//                epssgt02001:'02',
                cltpit01id:lsh,//药店流水号
                id:cltpro01id,//药品流水号
                cltpit01001:storeName, //药店名称
                name:proName, //记录药品名称
                comeFlag:'01', //访问来源标志:01app,02微信,03门户
                recordMark:'yes', //记录标志,
                saveParam:'4' //记录所属模块标志
            }
        },function(data){
            if(data.success) {

//                alert(JSON.stringify(data)+"^^^^^^^^^^^^^^^^^^^");

                var html='';
                var len=data.data.length;
                for(var i=0;i<len;i++){
                    html+='<div class="comment-list">';
                    html+='<div class="line-one">';
                    if(data.data[i].url){
                        html+='<div class="div-img"><img class="head-img" src="'+$.serverSettings.serverPath+'/mobile/mcheap/mcheapAction!getComUserPicture.do?access_token=' + $.getStorage('access_token') + '&url=' + data.data[i].url +'"/></div>';
                    }else{
                        html+='<div class="div-img"><img class="head-img" src="../image/head.jpg"/></div>';
                    }
                    if(data.data[i].isself){
                        if(data.data[i].epssgt07003){
                            html+='<div class="commentator-me">我<span class="commentator-price">价格:<span class="commentator-num">'+data.data[i].epssgt07003+'</span>元</span></div>';
                        }else{
                            html+='<div class="commentator-me">我</div>';
                        }
                    }else{
                        if(data.data[i].epssgt07003){
                            html+='<div class="commentator">'+data.data[i].epsrtu01002+'<span class="commentator-price">价格:<span class="commentator-num">'+data.data[i].epssgt07003+'</span>元</span></div>';
                        }else{
                            html+='<div class="commentator">'+data.data[i].epsrtu01002+'</div>';
                        }
                    }
                    html+='</div>';
                    html+='<div class="comment-detail">'+data.data[i].epssgt07002+'</div>';
                    html+='<div class="comment-time">'+data.data[i].create_time+'</div>';
                    html+='</div>';
                }
                $('.comment-lists').html(html);
                getProData();
                $('img').on('error',function(){
                    $(this).attr('src','../../../public/images/noImg.jpg');
                });
            }
            else {
                alert('网络错误')
            }
        });
    }

    //获取药品详情况
    function getProData(){
        $.request({
            urlType:'queryDrugstoreInfo',
            data:{
                "access_token": $.getStorage('access_token'),
                id:cltpro01id
            }
        },function(data){
            if(data.success) {

//                alert(data.data.element+"data.data.elementdata.data.element");

                if(data.data.element&&data.data.element!='null'){
                    var element = data.data.element;
                    var appearance = data.data.appearance;
                    var functions = (data.data.functions!='null')?data.data.functions:'';
                    var dosage = data.data.dosage;
                    var attentions = data.data.attentions;
                    var adversereactions = data.data.adversereactions;
                    var store = data.data.store;
                    var validitydate = data.data.validitydate;
                    $('.element').html(element);
                    $('.appearance').html(appearance);
                    $('.functions').html(functions);
                    $('.dosage').html(dosage);
                    $('.attentions').html(attentions);
                    $('.adversereactions').html(adversereactions);
                    $('.store').html(store);
                    $('.validitydate').html(validitydate);
                }else{
                    $('.xq-div').html('暂无数据');
                }
            }
            else {
                alert('网络错误')
            }
        });
    }

    //列表标题切换
    $('.second-title>div').on('tap',function(){
        if(1){
            var index=$(this).index();
            var ele=$('.classify-content>div');
            if(!$(this).hasClass('choose')){
                $('.second-title>div').removeClass('choose');
                $(this).addClass('choose');
                ele.hide();
                $('#con-'+index).show();
            }
        }else{
            alert('数据加载中，请稍等');
        }
    });

    //评论
    $(document).on('tap','.top-comment',function(){
        $.openWin({
            name:"ypxq_comment",
            animId : 2,
            url:'wgtroot://medicine/medicine_detail/ui/ypxq_comment.html',
            pageParam: {
                storeName:storeName,//药店名字
                id:cltpro01id,//药品流水号
                namemark:proName,//保存产品名称
                cltpit01id:lsh,//保存市场流水号
                factory:drugOrigin,//厂商
                proUrl:url//产品图片
            }
        });
    });

    //生成HTML页面
    function medicineQueryUserPrice(){
        $.request({
            urlType:'medicineQueryUserPrice',
            data:{
                access_token:$.getStorage('access_token'),
                cltpit01id:lsh,
                id:cltpro01id,
                pageSize:'10',
                page:pageNum
            }
        },function(data){
            if(data.success){
//                alert(JSON.stringify(data)+"获取报价");
                var lenG=data.data.assess.length;
                if(lenG){
                    setBaoJaData(data);
                }else{
                    if(pageNum==1){
                        setBaoJaData(data);
                    }else{
                        $.toast('没有更多了!');
                    }
                }
            }else{

            }
        });
    }


    function setBaoJaData(data){

        var html='',data_1=data.data.assess,len=data_1.length;
        for(var i=0;i<len;i++){
            html +='<div class="comment-list">';
            html +=' <div class="line-one">';
            if(data.data.assess[i].userurl){
                html +=' <div class="div-img"><img class="head-img" src="'+$.serverSettings.serverPath+'/mobile/mcheap/mcheapAction!getComUserPicture.do?access_token=' + $.getStorage('access_token') + '&url=' + data.data.assess[i].userurl +'"/></div>';
            }else{
                html +=' <div class="div-img"><img class="head-img" src="../image/head.jpg"/></div>';
            }
            html +=' <div class="commentator">'+data_1[i].epsrtu01002+'</div>';
            html +='</div>';
            html +=' <div class="comment-detail">报价:'+data_1[i].epsprice01004+'元 &nbsp;&nbsp;&nbsp;'+standard+'</div>';
            html +='<div class="pictures-box">';
            var picLen=data_1[i].url.length;
            if(picLen){
                for(var x= 0;x<picLen;x++){
                    html +='<img src="'+$.serverSettings.serverPath+'/mobile/mcheap/mcheapAction!getUserPricePicture.do?access_token=' + $.getStorage('access_token') + '&url=' + data_1[i].url[x].epsprice02002 +'"/>';
                }
            }
            html +=' </div>';
            html +='  <div class="comment-time">'+data_1[i].create_time+'</div>';
            html +=' </div>';
        }
        $(".con-4-content").append(html);
    }



    //发表评论
    $(".get-in").on("tap",function(){
        $(".set-price").show();
        $(".get-in").hide();
        $(".mask").show();
        $(".contents").show();
    });
    //点击确定
    $(document).on("tap",".set-price",function(){
        var input=$("#price-input").val();
        if(input){
            $(".contents").hide();
            $(".set-price").hide();
            $(".get-in").show();
            addUserPrice(input);
        }else{
            $.toast("请输入价格");
        }
    });
    //新增超市产品报价
    function addUserPrice(input){
        $("#price-input").val("");
        $.request({
            urlType:'medicineAddUserPrice',
            data:{
                access_token:$.getStorage('access_token'),
                cltpit01id:lsh,//药店流水号
                cltpit01001:drugOrigin,//药店名称
                epsprice01004:input,  //用户报价
                id :cltpro01id,//药品本位码
                epsprice01003:proName//药品名称
            }
        },function(data){
            if(data.success){
                var pic = $(".picture-box>img");
                var uploadlen=pic.length;
                var bz=data.data;
                if(uploadlen){
                    handleUploadFile(bz);
                    sendMsg(storeName,proName,input,'04');
                }else{
                    $.toast('报价成功!');
                    $(".mask").hide();
                    medicineQueryUserPrice();
                    sendMsg(storeName,proName,input,'04');
                }
            }else{
                $.toast('报价失败');
            }
        });
    }

    //报价完成后的成功回调
    function baojiaUploadSuccess(){
        $('.upload-mc').hide();
        $('.picture-box').html('');
        $.toast('图片上传完成');
        $('.mask').hide();
        pageNum=1;
        $('.con-4-content').html('');
        medicineQueryUserPrice();
    }

    /*
     拍照上传图片
     */
    /*拍照*/
    $(document).on('tap','.photo',function(){
        if(pNum<4){
            uexCamera.open(0,0);
            uexCamera.cbOpen=function(opId,dataType,data){
                var html='<img src="'+data+'">';
                $('.picture-box').append(html);
                pNum++;
            }
        }else{
            $.toast('亲！最多能上传三张图片！');
        }
    });

    /*从本地相册添加照片*/
    $(document).on('tap','.album',function(){
        if(pNum<4){
            uexImageBrowser.pick();
            uexImageBrowser.cbPick=function (opCode,dataType,data){
                var html='<img src="'+data+'">';
                $('.picture-box').append(html);
                pNum++;
            }
        }else{
            $.toast('亲！最多能上传三张图片！');
        }
    });
    //图片长按事件
    $(document).on('longtap','.picture-box>img',function(){
        $(this).remove();
        pNum--;
    });


    $(document).on('tap','.close-mc',function(){
        $('.mask').hide();
        $(".get-in").show();
    });

    $('.person-img').on('tap',function(){
        $('#price-input').blur();
    });
</script>
</body>
</html>