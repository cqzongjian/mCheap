<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>mCollection</title>
    <meta name="viewport" content="target-densitydpi=device-dpi,width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../../../static/mdui/css/mdui.min.css">
    <link rel="stylesheet" href="../../../static/mCheap/css/mCommon.css">
    <link rel="stylesheet" href="../css/host_main.css">

</head>

<body>

<div class="header-box mdui-bar mdui-bar-nav-ios mdui-box">
    <div class="header">
        <div class="back mdui-action-back" style="text-align: center;margin-top: 0.8rem;"><img src="../images/back.png" style="width: 0.8rem;height: 1.3rem;"></div>
    </div>
    <div class="mdui-box-flex-1 mdui-box search-box">
        <div class="mdui-box-flex-1">
            <input type="text" id="search" placeholder="药品或医疗服务信息"/>
        </div>
        <div class="search-img"><img src="../images/search.png"></div>
    </div>
    <!--<div class="share-log"></div>-->
</div>
<div class="top" style="margin-top: 4rem">
    <img src="../images/large.jpg">
    <div class="top-over">
        <div class="top-title">成都市马布里</div>
        <div class="top-sub mdui-box">
            <div class="mdui-box-flex-1 address">成都市青羊区大众和宝马</div>
            <div class="dis" style="margin-right: .5rem;">11km</div>

        </div>
        <div class="top-time ">门诊时间：（8:30-17:30）</div>
        <div class="hos_level" >二级甲等</div>
        <div style=" position: absolute;top:.8rem; width: 10rem;right:0rem"><div class="islike dislike"></div></div>
    </div>
</div>
<div class="nav mdui-box">
    <div class="mdui-box-flex-1 nav-item">
        <div class="nav-item-on" id="yp">药品信息</div>
    </div>
    <div class="gap-line">|</div>
    <div class="mdui-box-flex-1 nav-item">
        <div id="service">医疗服务</div>
    </div>
</div>

<div class="sort-box">
    <!--<div class="bottom-sort-box">-->
    <!--<div class="bottom-sort-title-box list">-->
    <!--<div class="list-item mdui-box touch">-->
    <!--<div class="mdui-box-flex-1 " style="padding-left: .5rem">抗病毒药</div><div class="arrow"></div></div></div>-->
    <!--<div class="bottom-sort-title-box list">-->
    <!--<div class="list-item mdui-box touch">-->
    <!--<div class="mdui-box-flex-1 ">糖尿病</div>-->
    <!--<div class="arrow"></div>-->
    <!--</div></div></div>-->
    <!--<div class="sort-title-box list list-title">-->
    <!--<div class="list-item mdui-box">-->
    <!--<div class="mdui-box-flex-1">皮肤病</div>-->
    <!--<div class="up-down down"></div>-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="bottom-sort-box">-->
    <!--<div class="bottom-sort-title-box list">-->
    <!--<div class="list-item mdui-box touch">-->
    <!--<div class="mdui-box-flex-1">疱疹</div>-->
    <!--<div class="arrow"></div>-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="bottom-sort-title-box list">-->
    <!--<div class="list-item mdui-box touch">-->
    <!--<div class="mdui-box-flex-1">白癜风</div>-->
    <!--<div class="arrow"></div>-->
    <!--</div>-->
    <!--</div>-->
    <!--</div>-->
</div>

<div class="medicen_lists">
    <div class="medicen_listtop">
        <div class="sort-title-box list list-title">
            <div class="list-item mdui-box">
                <div class="mdui-box-flex-1 medicen_prevname"></div>
                <div class="up-down sx"></div>
            </div>
        </div>
    </div>
    <div class="medicen_list">

    </div>
</div>
<!--</div>-->
<!--<div class="list-item">-->
<!--<div class="item-content mdui-box">-->
<!--<div class="item-img"><img src="../images/blg.png"></div>-->
<!--<div class="mdui-box-flex-1">-->
<!--<div class="item-title">板蓝根颗粒</div>-->
<!--<div class="item-sub">产地：四川成都</div>-->
<!--<div class="mdui-box item-bottom">-->
<!--<div class="item-price mdui-box-flex-1">￥10.80</div>-->
<!--<div class="item-time">2016-07-08 8:00</div>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
<!--<div class="list-item">-->
<!--<div class="item-content mdui-box">-->
<!--<div class="item-img"><img src="../images/blg.png"></div>-->
<!--<div class="mdui-box-flex-1">-->
<!--<div class="item-title">板蓝根颗粒</div>-->
<!--<div class="item-sub">产地：四川成都</div>-->
<!--<div class="mdui-box item-bottom">-->
<!--<div class="item-price mdui-box-flex-1">￥10.80</div>-->
<!--<div class="item-time">2016-07-08 8:00</div>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
<!--<div class="list-item">-->
<!--<div class="item-content mdui-box">-->
<!--<div class="item-img"><img src="../images/blg.png"></div>-->
<!--<div class="mdui-box-flex-1">-->
<!--<div class="item-title">板蓝根颗粒</div>-->
<!--<div class="item-sub">产地：四川成都</div>-->
<!--<div class="mdui-box item-bottom">-->
<!--<div class="item-price mdui-box-flex-1">￥10.80</div>-->
<!--<div class="item-time">2016-07-08 8:00</div>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
<div class="select"></div>
<script src="../../../static/mdui/js/mdui.min.js"></script>
<script src="../../../static/mCheap/js/mCheap.config.js"></script>
<script src="../../../server.js"></script>
<script src="../../../public.js"></script>
<script>
    var tabNum='1';
    var hos_cltmdc01009;
    var title;
    var address;
    var time;
    var distance;
    var clthtp01013;
    var focus;
    var log;
    var lat;
    var requestSflag=true;

    var obj={pageNum:1,requestFlag:true,tabFlag:1};

    $.uexWindowReady(function(){

        var option = {id:"list1",funs:{after:function(){
            if(obj.requestFlag&&obj.tabFlag==1){
                obj.pageNum=obj.pageNum+1;
                getHosmedicenContent();
            }else{
                $.toast('没有更多了!');
            }
        }}};
        var option1 = {id:"list2",funs:{after:function(){
            if(obj.requestFlag&&obj.tabFlag==2){
                obj.pageNum=obj.pageNum+1;
                getHosmeService();
            }else{
                $.toast('没有更多了!');
            }
        }}};
        $.initScroll(option);
        $.initScroll(option1);





//        weChat.init();
        /*
         模拟数据
         */
        var pageData = $.strToJson($.pageParam);
        initHosTop(pageData);
        //药品详细信息
        gethosmedicnequeryCategory();
        //queryCategory药品分类接口
        getHosmeService();
    });
    /*
     加载头部页面
     */
    function initHosTop(pageData){
        hos_cltmdc01009 = pageData.cltpit01id;
        title =pageData.title;
        address = pageData.address;
        distance = pageData.distance;
        time  =pageData.time;
        focus=pageData.focus;
        log=pageData.log;
        lat=pageData.lat;
        if(parseInt(focus)){
            $('.islike').removeClass('dislike').addClass('like');
        }else{
            $('.islike').removeClass('like').addClass('dislike');
        }
        clthtp01013 = hosLevle(pageData.clthtp01013);//等级id
        $(".top .top-title").html(title);
        $(".top .address").html(address);

        $(".top .top-time").html("门诊时间：("+ time+")");
        if( distance == 0){
            $(".top .dis").html("");
        }else{
            $(".top .dis").html(distance+"km");
        }
        $(".hos_level").html(clthtp01013);
    }
    /*
     获取药品分类信息
     */
    function gethosmedicnequeryCategory(){
        showMask(true, '正在加载药品信息...', 1000, 1);
        $.request({
                urlType: 'hosmedicne_queryCategory',
                data: {
                    "access_token": $.getStorage('access_token'),
                    clthtp01id: hos_cltmdc01009,
                    clthtp01001:title, //医院名称
                    comeFlag:'01', //访问来源标志:01app,02微信,03门户
                    recordMark:'yes', //记录标志,
                    saveParam:'6' //记录所属模块标志
                }
            },function(data) {
                if (data.success) {
                    $.closeToast();
                    var json=data.data;
                    setMidecine(json);
                }
                else {
                    //$.toast("网络错误")
                }
            }
        )}
    /*
     获取医院药品详细信息
     @param id 医院id
     @param type 症状名称
     */
    function getHosmedicenContent(){
        $.request({
            urlType: 'hosmedicen_content',
            data:{
                "access_token": $.getStorage('access_token'),
                "cltmdc01009":hos_cltmdc01009,
                'smalltype':obj.type,
                page:obj.pageNum ,
                pageSize:'10'
            }
        },function(data){
            if(data.success) {
                var json=data.data;
                if(json.length){
                    setHosmedicenContent(json,obj.type);
                }else{
                    if(obj.pageNum==1){
                        setHosmedicenContent(json,obj.type);
                    }else{
                        $.toast('没有更多了!');
                        obj.requestFlag=false;
                    }
                }
            }
        })
    }
    /*
     获取医院服务信息
     @param id 医院id
     @param type 症状名称
     */
    function getHosmeService(){
        $.request({
            urlType: 'hosiptalService',
            data:{
                "access_token": $.getStorage('access_token'),
                clthtp01id:hos_cltmdc01009,
                page:obj.pageNum ,
                pageSize:'10',
                clthtp01001:title //医院名称
            }
        },function(data){
            if(data.success) {
                var lend=data.data.length,json=data.data;
                if(lend){
                    setHosmeService(json);
                }else{
                    if(obj.pageNum==1){
                        setHosmeService(json);
                    }else{
                        $.toast('没有更多了!');
                        obj.requestFlag=false;
                    }
                }
            }
        })
    }
    /*
     设置医院药品大类
     */

    function setMidecine(data){
        var html ="",len=data.length;
        if(len){
            for(var i = 0;i<len;i++){
                html += '<div class="sort-title-box list list-title">';
                html += '<div class="list-item mdui-box">';
                html += '<div class="mdui-box-flex-1">';
                html += data[i].midname;//设置药品大类名称
                html += '</div>';
                html += '<div class="up-down down"></div>';
                html += '</div></div>';
                html += '<div class="bottom-sort-box">';
                for(var j = 0,len1=data[i].smallname.length;j<len1;j++){
                    html += ' <div class="bottom-sort-title-box list">';
                    html += '<div class="list-item mdui-box touch">';
                    html += '<div class="mdui-box-flex-1 ">&nbsp;&nbsp;&nbsp;';
                    html += data[i].smallname[j];
                    html +='</div>';
                    html +='<div class="arrow"></div></div></div>'
                }
                html += '</div>';
                /*载入点击事件
                 * 点击获取医院药品详细信息
                 */
                $(".sort-box-one").html(html).show();
            }
        }else{
            html='<div class="no-data">暂无数据</div>';
            $(".sort-box-one").html(html);
        }
    }

    $(document).on('tap','.touch',function(){
        $('#list1').html('');
        obj.type = $(this).text().trim();
        getHosmedicenContent();
    });



    /*
     * 设置医院服务相关信息
     **/
    function setHosmeService(data){
        var html ="",len=data.length;
        if(len){
            for( var i = 0;i<len;i++){
                html +='<div class="list-item">';
                html +='<div class="item-content mdui-box">';
                html +='<div class="mdui-box-flex-1">';
                html += data[i].cltmds01002; //医疗服务名称
                html +='</div>';
                html += '<div class="mdui-box item-bottom">';
                html += '<div class="item-price mdui-box-flex-1">';
                html +=  data[i].cltmds01006;
                html+= '</div>';
                html +='<div class="item-time">元/';
                html +=data[i].cltmds01005;
                html +='</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }
            $(".sort-box").append(html);
        }else{
            html='<div class="no-data">暂无数据</div>';
            $(".sort-box").html(html);
        }
    }

    /*
     设置医院药品详细信息
     */
    function setHosmedicenContent(data,type){
        var htmlSet = "",len=data.length;
        if(len){
            for(var m = 0;m<len;m++){
                htmlSet += '<div class="list-item ypxq" >';
                htmlSet += '<div class="item-content mdui-box datacode" id="'+data[m].drugStandardCode +'"> ';
                htmlSet += '<div class="item-img"><img src="../images/blg.jpg"></div>';
                htmlSet += '<div class="mdui-box-flex-1">';
                htmlSet +='<div class="item-title med_name">';
                htmlSet += data[m].cltmdc01001;
                htmlSet += '</div>';
                htmlSet += '<div class="mdui-box item-bottom">';
                htmlSet += '<div class="item-price mdui-box-flex-1 chandi">产地:';
                htmlSet += data[m].cltmdc01005;
                htmlSet +='</div>';
                htmlSet +='<div class="item-time num">';
                htmlSet += data[m].cltmdc01004;
                htmlSet +='</div>';
                htmlSet +='</div>';
                htmlSet += '<div class="mdui-box item-bottom">';
                htmlSet += '<div class="item-price mdui-box-flex-1 mddicen_price">￥';
                htmlSet +=data[m].cltmdc01007;
                htmlSet += '</div>';
                htmlSet +='<div class="item-time medicen_time">';
                htmlSet +=data[m].cltmdc01010;
                htmlSet +='</div>';
                htmlSet += '</div>';
                htmlSet +='</div>';
                htmlSet +='</div>';
                htmlSet +='</div>';
            }
            $(".medicen_prevname").html(type);
            $(".medicen_lists").show();
//            $(".medicen_listtop").show();
            $(".medicen_list").append(htmlSet).show();
            $(".sort-box").hide();
            $(".sort-box-one").hide();
        }else{
            htmlSet+='<div class="no-data">暂无数据</div>';
            $('.medicen_list').html(htmlSet).show();
        }
    }

    $(document).on('click','.ypxq',function(){
        var code = $(this).find("div .datacode").attr("id");
        var medtitles =$(this).find("div .med_name").text();
        var medchandis = $(this).find("div .chandi").text();
        var medprices = $(this).find("div .mddicen_price").text();
        var medtimes = $(this).find("div .medicen_time").text();
        var num = $(this).find("div .num").text();
        $.openWin({
            name: "hos_medicine",
            animId : 2,
            url: 'wgtroot://hospital/hos_medicine/ui/hos_medicine.html',
            pageParam:{
                code:code,
                title:medtitles,
                chandi:medchandis,
                price:medprices,
                time:medtimes,
                num:num,
                clthtp01id:hos_cltmdc01009,
                clthtp01001:title
            }
        });
    });

    /*
     点击打开下拉选项
     */
    $(".sort-box-one").on('click','.up-down',function(){
        if($(this).hasClass('down')){
            $(this).parents().next().show();
            $(this).removeClass('down').addClass('up');
        }else{
            $(this).parents().next().hide();
            $(this).removeClass('up').addClass('down');
        }
        $('.sort-box').hide();
    });


    /*
     点击筛选退回药品类别选择
     */
    $(".sort-title-box").on('tap','.sx',function(){
        $(".medicen_lists").hide();
        $(".sort-box").hide();
        $(".sort-box-one").show();
    });
    /*
     点击关注按钮
     */

    $('.top-over').on('click','.islike',function(){
        var that=$(this);
        if(that.hasClass('dislike')){
            $.request({
                urlType:'hos_addFocusHosiptal',
                data:{
                    'access_token':$.getStorage('access_token'),
                    clthtp01id:hos_cltmdc01009,//医院id
                    clthtp01001:title//医院名称
                }
            },function(data){
                if(data.success){
                    $.toast("成功关注");
                    that.removeClass('dislike').addClass('like');
                    $.execScript({
                        winName:'hos_list',
                        frameName:'hospital_content',
                        script:'requestFocusHos()'
                    });
                }else{
                    $.toast("网络异常 ,清稍后再试！")
                }
            });
        }else{
            $.request({
                urlType:'hos_delFocusHosiptal',
                data:{
                    'access_token':$.getStorage('access_token'),
                    clthtp01id:hos_cltmdc01009,//医院id
                    clthtp01001:title//医院名称
                }
            },function(data){
                if(data.success){
                    $.toast("取消关注");
                    that.removeClass('like').addClass('dislike');
                    $.execScript({
                        winName:'hos_list',
                        frameName:'hospital_content',
                        script:'requestFocusHos()'
                    });
                }else{
                    $.toast("网络异常 ,清稍后再试！")
                }
            });
        }
    });

    /*
     切换药品信息和医疗服务
     */

    $("#yp").on("click",function () {
        tabNum=$(this).data('tab');
        obj.tabFlag=1;
        obj.pageNum=1;
        $(".sort-box").hide();
        $(".sort-box-one").show();
//        gethosmedicnequeryCategory();
        $('#service').removeClass("nav-item-on");
        $('#yp').addClass("nav-item-on");
    });

    $('#service').on("click",function(){
        tabNum=$(this).data('tab');
        obj.tabFlag=2;
        obj.pageNum=1;
        $(".sort-box-one").hide();
        $(".sort-box").show();
        $('#yp').removeClass("nav-item-on");
        $('#service').addClass("nav-item-on");
        $(".medicen_list").hide();
        $(".medicen_lists").hide();
        if(requestSflag){
            recordService();
            requestSflag=false;
        }
    });

    function recordService(){
        $.request({
            urlType:'gettoken',
            data:{
                'access_token':$.getStorage('access_token'),
                clthtp01id:hos_cltmdc01009,//医院id
                clthtp01001:title,//医院名称
                cltmds01001:'service', //医疗服务标志
                comeFlag:'01', //访问来源标志:01app,02微信,03门户
                recordMark:'yes', //记录标志,
                saveParam:'6' //记录所属模块标志
            }
        },function(){

        },null,function(){

        });
    }
    /*
     点击药品详情打开要品详情页
     */
    function showMask(isShowToast, msg, times, isProcess) {
        if (isShowToast) {
            $.toast({
                msg : msg,
                duration : times * 1000,
                position : 5,
                type : isProcess ? 1 : 0
            });
        }
    }
    function hosLevle(data){
        switch (data){
            case '0101':
                return '一级甲等';
            case '0102':
                return '一级乙等';
            case '0103':
                return '一级丙等';
            case '0201':
                return '二级甲等';
            case '0202':
                return '二级乙等';
            case '0203':
                return '二级丙等';
            case '0301':
                return '三级甲等';
            case '0302':
                return '三级乙等';
            case '0303':
                return '三级丙等';
            default:
                return '未知';
        }

    }

    //点分享
    $(document).on('tap','.share-log',function(){
        $('.mc').show();
    });

    //注册微信
    $(document).on('tap','.weichat-img',function(){
        var option={
            thumbImg:'../images/share_hospital.png',//(必选)(大小必须小于32k)
            wedpageUrl:'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx884671f313119520&redirect_uri=http://xm.yhxzdz.com/gongyi/maicai/hospital/index/ui/hospital_index.html&response_type=code&scope=snsapi_base&state=123#wechat_redirect',//(必选)链接的地址
            scene:'0',//(必选)发送的目标场景 0-会话场景 1-朋友圈场景
            title:'找相因',//(必选)链接的标题
            description:hos_cltmdc01009//(必选)描述
        };
        weChat.shareLink(option);
    });

    //点击取消
    $(document).on('tap','.share-cancel',function(){
        $('.mc').hide();
    });

    $('.top-over').on('tap','.address',function(){
        $.toast('开始导航!');
        $.openWin({
            animId : 2,
            name: "navigation",
            url: 'wgtroot://mCheap/map/ui/navigation.html',
            pageParam: {
                lng:log,
                lat:lat,
                marketName:title
            }
        });
    });


    $('.info-search').on('tap',function(){
        $.openWin({
            animId : 2,
            name: "navigation",
            url: 'wgtroot://mCheap/map/ui/navigation.html',
            pageParam: {
                lng:log,
                lat:lat,
                marketName:title
            }
        });
    });

    $('.search-img').on('tap',function(){
        if(tabNum=='1'){
            $.openWin({
                animId : 2,
                name: "hos_info_search",
                url: 'wgtroot://hospital/hos_info_search/ui/hos_info_search.html',
                pageParam: {
                    title:'药品信息',
                    hos_cltmdc01009:hos_cltmdc01009,
                    hos_name:title
                }
            });
        }else{
            $.openWin({
                animId : 2,
                name: "hos_info_search",
                url: 'wgtroot://hospital/hos_info_search/ui/hos_info_search.html',
                pageParam: {
                    title:'医疗服务',
                    hos_cltmdc01009:hos_cltmdc01009,
                    hos_name:title
                }
            });
        }
    })

    //    $(".back").on("tap",function(){
    //        $.closeWin();
    //    });
</script>
</body>
</html>