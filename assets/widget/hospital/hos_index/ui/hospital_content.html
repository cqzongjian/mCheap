<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>mCollection</title>
	<meta name="viewport" content="target-densitydpi=device-dpi,width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link rel="stylesheet" href="../../../static/mdui/css/mdui.min.css">
	<link rel="stylesheet" href="../../../static/mCheap/css/mCommon.css">
	<link rel="stylesheet" href="../css/index_content.css">
	<link rel="stylesheet" href="../css/market_list.css">
</head>
<style>
	html,body{
		height: 100%;
	}
	body{
		position: relative;
		overflow:hidden;
	}
	.seting{
	}
	.setting-detail{
		position: absolute;
		top: 5.3rem;
		bottom: 0;
		width: 100%;
		background-color: rgba(0,0,0,0.3);
		display: none;
		overflow: hidden;
		z-index: 100;
	}
	.item{
		padding: 0.5rem 0;
		color: #333333;
		line-height: 1.5rem;
		background-color: #ffffff;
		border-bottom: 1px solid #CCCCCC;
	}
	.item>div{
		border-right: .1rem solid #CCCCCC;
		width: 50%;
		text-align: center;
		position: relative;
	}
	.item>div>img{
		height: 0.3rem;
		width: auto;
		position: relative;
		top: -0.15rem;
		display: inline-block;
	}
	.item>div:last-child{
		border: none;
	}
	.item .item-on{
		color: #0eb7ed;
	}
	.detail{
		line-height: 2rem;
		background-color: #ffffff;
		color: #666666;
		position: relative;
		z-index: 100;
	}
	ul{
		padding: 0;
		margin: 0;
	}
	li{
		list-style: none;
		border-bottom: 1px solid #cccccc;
		padding-left: 3rem;
	}
	li:last-child{
		border-bottom: none;
	}

	.for-near{
		display: none;
	}
	.for-shaixuan{
		display: none;
	}
	.mdui-checkbox input[type=checkbox]:checked:before, .mdui-radio input[type=radio]:checked:before {
		color: #0eb7ed;
	}
	.select-box>.mdui-input-row{
		border-bottom: 1px solid #cccccc;
	}
	#gzCaipin{
		border-bottom: none;
	}
	#btn-group{
		padding:0.5rem 0.5rem 0.5rem 1rem ;
		background-color: #F7F7F7;
	}
	#btn-group>input{
		display: block;
	}
	#rest{
		float: left;
	}
	#confirm{
		background-color: #0eb7ed;
		color: #FFFFFF;
		float: right;
	}
	.mdui-checkbox input[type=checkbox], .mdui-radio input[type=radio] {
		right: 0.3rem;
	}
	.list{
		overflow: auto;
	}
	.level{
		padding: 0 !important;
	}
	.level-child{
		background-color: #0eb7ed;
	}

</style>
<body>
<div class="search-before-content">
	<div class="searching">努力搜索中...</div>
</div>
<div class="search-item-content"></div>
<div class="header mdui-bar mdui-bar-nav mdui-box " style="padding-left: 0;">
	<div class="saoma">
		<img src="../image/back.png">
	</div>
	<div class="mdui-box-flex-1 mdui-box search-box">
		<div class="mdui-box-flex-1">
			<form action="">
				<input type="text" id="search" placeholder="医院"/>
			</form>
		</div>
		<div class="search-img"><img src="../image/searchhos.png"></div>
	</div>

</div>
<div id="slider" class="mdui-slider">
	<div class="mdui-slider-group mdui-slider-loop">
		 <!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
		 <!--<div class="mdui-slider-item mdui-slider-item-duplicate">-->
			<!--<a href="#">-->
				<!--<img src="../image/hos_slider/3.jpg">-->
				<!--<div class="mask"></div>-->
			<!--</a>-->
		<!--</div>-->
		<!--&lt;!&ndash; 第一张 &ndash;&gt;-->
		<!--<div class="mdui-slider-item">-->
			<!--<a href="#">-->
				<!--<img src="../image/hos_slider/1.jpg">-->
				<!--<div class="mask">-->
					<!--<div class="mask-title"></div>-->
					<!--<div class="mask-sub"></div>-->
				<!--</div>-->
			<!--</a>-->
		<!--</div>-->
		<!--&lt;!&ndash; 第二张 &ndash;&gt;-->
		<!--<div class="mdui-slider-item">-->
			<!--<a href="#">-->
				<!--<img src="../image/hos_slider/2.jpg">-->
				<!--<div class="mask"></div>-->
			<!--</a>-->
		<!--</div>-->
		<!--&lt;!&ndash; 第三张 &ndash;&gt;-->
		<!--<div class="mdui-slider-item">-->
			<!--<a href="#">-->
				<!--<img src="../image/hos_slider/3.jpg">-->
				<!--<div class="mask"></div>-->
			<!--</a>-->
		<!--</div>-->
		<!--&lt;!&ndash; 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) &ndash;&gt;-->
		<!--<div class="mdui-slider-item mdui-slider-item-duplicate">-->
			<!--<a href="#">-->
				<!--<img src="../image/hos_slider/1.jpg">-->
				<!--<div class="mask"></div>-->
			<!--</a>-->
		<!--</div>-->
	</div>
	<div class="mdui-slider-indicator">
		<div class="mdui-indicator mdui-active"></div>
		<div class="mdui-indicator"></div>
		<div class="mdui-indicator"></div>
	</div>
</div>

<div style="height: 0.5rem;background-color: #E6EAE8"></div>
<div class="tj-market">
	<div class="tj-title"><img src="../image/caipu_on.png">&nbsp;附近医院</div>
	<div class="tj-more near-hos">更多&nbsp;<img src="../image/you.png"></div>
	<div class="nearHospital">


		<!--<div class="tj-list-item mdui-box">-->
		<!--<div>-->
		<!--<img src="../images/kb.png">-->
		<!--</div>-->
		<!--<div class="mdui-box-flex-1">-->
		<!--<div class="list-item-title">双人青椒肉丝套fsdfsfs阿斯顿发生的发生大发</div>-->
		<!--<div class="star"><img src="../images/star_01.png"/><img src="../images/star_02.png"/><img src="../images/star_03.png"/><img src="../images/star_02.png"/><img src="../images/star_03.png"/></div>-->
		<!--<div class="market-address">府城大道东段77号</div>-->
		<!--<div class="market-yysj">营业时间：8:00-17:00</div>-->
		<!--</div>-->
		<!--<div class="market-dis">1.7km</div>-->
		<!--</div>-->


	</div>
</div>
<div style="height: 0.5rem;background-color: #E6EAE8"></div>

<div class="tj-market">
	<div class="tj-title"><img src="../image/caipu_on.png">&nbsp;关注医院</div>
	<div class="tj-more focus-hos">更多&nbsp;<img src="../image/you.png"></div>
	<div class="focusHospital">


		<!--<div class="tj-list-item mdui-box">-->
		<!--<div>-->
		<!--<img src="../images/kb.png">-->
		<!--</div>-->
		<!--<div class="mdui-box-flex-1">-->
		<!--<div class="list-item-title">双人青椒肉丝套fsdfsfs阿斯顿发生的发生大发</div>-->
		<!--<div class="star"><img src="../images/star_01.png"/><img src="../images/star_02.png"/><img src="../images/star_03.png"/><img src="../images/star_02.png"/><img src="../images/star_03.png"/></div>-->
		<!--<div class="market-address">府城大道东段77号</div>-->
		<!--<div class="market-yysj">营业时间：8:00-17:00</div>-->
		<!--</div>-->
		<!--<div class="market-dis">1.7km</div>-->
		<!--</div>-->


	</div>
</div>
<div style="height: 0.5rem;background-color: #E6EAE8" id="for_foucsMarket"></div>
<div class="tj-caipu">
	<div class="tj-title"><img src="../image/caipu_on.png">&nbsp;医院等级</div>
	<div class="tj-more">更多&nbsp;<img src="../image/you.png"></div>
		<div class="item mdui-box level"  >
			<div class="item-nears level-child"  id="level1"  level="0301">
				<div style="display: inline-block; padding-right: .2rem;" >三甲</div>
			</div>
			<div class="item-nears "  id="level2" level="0302">
				<div style="display: inline-block; padding-right: .2rem;">三乙</div>
			</div>
			<div class="item-nears "  id="level3" level="0201">
				<div style="display: inline-block; padding-right: .2rem;">二甲</div>
			</div>
			<div class="item-nears "  id="level4" level="0202">
				<div style="display: inline-block;padding-right: .2rem;">二乙</div>

			</div>
		</div>
	<div class="tj-list">

	</div>

</div>


<!--页面-->
<script src="../../../static/mdui/js/mdui.js"></script>
<script src="../../../static/mCheap/js/mCheap.config.js"></script>
<script src="../../../server.js"></script>
<script src="../../../public.js"></script>
<script src="../../../static/mCheap/js/btn_click.js"></script>
<script src="../../../static/mdui/js/imageHandler.js"></script>
<script src="../../../static/mdui/js/imageConfig.js"></script>
<script src="../js/hos_main.js"></script>
<script>
	var priceArr={};
	var image;
	var datanear={};
	var dataLevle ={};
    var posArr = [];	//存储3分钟前和现在的位置信息
    var ids = [];		//存储两个医院id，3分钟前和现在
    var distances = [];	//存储两个医院距离，3分钟前和现在
	$.uexWindowReady(function(){
		var oForm =  document.getElementsByTagName("form")[0];
		oForm.onsubmit = function(){
			$('.search-img').trigger('tap');
			return false;
		};
		image = $.imageHandler;
		image.init($.imageOptions);

		var near= $.getStorage('near')?$.getStorage('near'):0;//当前附近索引
		var nearArr=['附近','1km','2km','3km','4km','全城'];//附近数组
		$('.for-near>ul>li').eq(near).addClass('li-on');
		$('.item-near>div:first-child').html(nearArr[near]);

		//请求附近医院、医院信息、菜谱
        initHosPage();
        setInterval(refresh,180000);//3分钟刷新一次

		/*下拉刷新*/
        $.setBounce({
            bounceType:"1",
            type:"0",
            startPullCall:function(){
                //console.log("下拉动作开始");
            },
            downEndCall:function(type){
                //执行刷新数据
                initHosPage();
                //关闭上/下拉刷新效果
                $.resetBounce(type);
            }
        });

	});


    var $reLoading = $('<div style="height:10rem" class="mdui-box mdui-box-ver mdui-box-pack-center mdui-box-align-center" id="load_recommend"><div style="height: 1rem"></div></div>');
    var $favLoading = $('<div style="height:10rem" class="mdui-box mdui-box-ver mdui-box-pack-center mdui-box-align-center" id="load_favorite"><div style="height: 1rem"></div></div>');

    function initHosPage() {
        getHosContent();
        hosiptalLeve();
        requestFocusHos();
    }

    function getDisance(lat1, lng1, lat2, lng2) {
        var radLat1 = lat1 * Math.PI / 180.0;
        var radLat2 = lat2 * Math.PI / 180.0;
        var a = radLat1 - radLat2;
        var b = lng1 * Math.PI / 180.0 - lng2 * Math.PI / 180.0;
        var s = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a / 2), 2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / 2), 2)));
        s = s * 6378.137;
        s = Math.round(s * 10000) / 10000;
        return s
    }

    //刷新页面
    function refresh() {
        var posObj = {
            log : $.getStorage('log'),
            lat : $.getStorage('lat')
        };
        if(posArr.length>=2){
            posArr.shift();
        }
        posArr.push(posObj);

        var lastLat = posArr[0].lat;
        var lastLog = posArr[0].log;
        var curLat = posArr[1].lat;
        var curLog = posArr[1].log;
        var distance = getDisance(lastLat, lastLog, curLat, curLog);
//alert('当前坐标：'+'('+curLat+','+curLog+')'+',上次坐标：'+'('+lastLat+','+lastLog+')'+',距离：'+distance);
        if(distance>0.1) {	//如果距离大于100km
            $.request({
                urlType: 'hosContent',
                data: {
                    'access_token': $.getStorage('access_token'),
                    'log':$.getStorage('log'),//经度,
                    'lat':$.getStorage('lat'),//纬度
                    'homepage':'01'
                }
            }, function (json) {
                if (json.success) {
//console.log("附近医院: "+JSON.stringify(json));
                    ids.push(json.data[0].clthtp01id);
                    distances.push(json.data[0].distance);
                    if(ids.length>=2){
                        ids.shift();
                    }
                    if(distances.length>=2){
                        distances.shift();
                    }
                    if(ids[0]!=ids[1] || distances[0]!=distances[1]){
                        $.refreshWin();
                    }
                }else {
                    $.alert('网络错误');
                }
            });
        }
    }



    function getHosContent() {
        var posObj = {
            log : $.getStorage('log'),
            lat : $.getStorage('lat')
        };
        posArr.push(posObj);
        $.request({
            urlType: 'hosContent',
            data: {
                'access_token': $.getStorage('access_token'),
                'log':$.getStorage('log'),//经度,
                'lat':$.getStorage('lat'),//纬度
                'homepage':'01'
            }
        }, function (json) {
            hideLoading("load_recommend");
            hideLoading("load_favorite");
            datanear = json;
            if (json.success) {
                var data=json.data;
                requestNearHos(data);
                setBanner(data);
                $('.tj-caipu,.tj-like').find('img').on('error',function(){
                    $(this).attr('src','../../../public/images/noImg.jpg');
                });
                $('#slider,.tj-market,.focusMarket').find('img').on('error',function(){
                    $(this).attr('src','../image/kb.png');
                });
            }else {
                $.alert('网络错误');
            }
        },function(){
            if($("#load_recommend").length==0)$(".tj-list").append($reLoading);
            showLoading("load_recommend");
            if($("#load_favorite").length==0)$(".tj-list").append($favLoading);
            showLoading("load_favorite");
        },function(){
            //网络错误
//			$favLoading.find("div").html("网络错误,请稍后重试");
//			$reLoading.find("div").html("网络错误,请稍后重试");
        });
    }

	//请求医院等级
	function hosiptalLeve(){
		$.request({
			urlType: 'hosiptalLeve',
			data: {
				"access_token": $.getStorage('access_token'),
				"log": $.getStorage('log'),//经度
				"lat": $.getStorage('lat')//纬度
			}
		}, function (data) {
			if (data.success) {
				if (data.data.length > 0) {
					dataLevle = data;
					clickHosLevel();
				}
			}
			else {
                //$.toast('网络错误');
			}
		});
	}

	function requestNearHos(data){
		var html=creatHtml(data);
		$('.nearHospital').html(html);
	}

	//请求首页关注医院
	function requestFocusHos(){
		$.request({
			urlType: 'hos_fouceHosiptalInfo',
			data: {
				"access_token": $.getStorage('access_token'),
				homepage:'yes'
			}
		}, function (json){
			if(json.success){
				var data=json.data;
				var html=creatHtml(data);
				$('.focusHospital').html(html);
			}else{
				alert('网络错误');
			}
		});
	}

	/**
	 * 点击医院等级
	 **/
	function clickHosLevel(){
		//用来加载最开始的初始化
		setYouLike(dataLevle.data[0].ThreeA,true,1);
		$(".item-nears").on("tap",function(){
			var id = ($(this).attr("id"));
			var level = ($(this).attr("level"));
			$(".item-nears").removeClass("level-child");
			$("#"+id).addClass("level-child");
			if(level == '0301'){
				//三甲
				setYouLike(dataLevle.data[0].ThreeA,true,1);
			}else if(level == '0302'){
				//三乙
				setYouLike(dataLevle.data[0].ThreeB,true,2);
			}else if(level == '0201'){
				//二甲
				setYouLike(dataLevle.data[0].TwoA,true,3);
			}else if(level == '0202'){
				//二乙
				setYouLike(dataLevle.data[0].TwoB,true,4);
			}
		});
	}

	/*
	 * 点击附近医院列表
	 * */
	$('.tj-market').on('tap','.tj-list-item',function(){
		var cltpit01id=$(this).data('cltpit01id');
		var title = $(this).data('title');
		var address = $(this).data('address');
		var distance = $(this).data('distance');
		var clthtp01013 = $(this).data('clthtp01013');
		var time = $(this).data('time');
		var log = $(this).data('log');
		var lat = $(this).data('lat');
		$.openWin({
			name:'hos_main',
			animId : 2,
			url:'wgtroot://hospital/hos_main/ui/hos_main.html',
			pageParam:{
				cltpit01id:cltpit01id,
				title:title,
				address:address,
				distance:distance,
				clthtp01013:clthtp01013,
				time:time,
				focus:$(this).data('focus'),
				lat:lat,
				log:log
			}
		});
	});

	/*
	 点击附近医院更多列表
	 */
	$('.near-hos').on('tap',function(){
		$.execScript({
			winName:'hos_list',
			script:'$(".fj-more").trigger("tap");'
		});
	});
	/*
	 点击关注医院更多列表
	 */
	$('.focus-hos').on('tap',function(){
		$.execScript({
			winName:'hos_list',
			script:'$(".gz").trigger("tap");'
		});
	});
	/*
	 点击医院等级更多列表
	 */
	$('.tj-caipu').on('tap','.tj-more',function(){
		$.execScript({
			winName:'hos_list',
			script:'$(".fj-more").trigger("tap");'
		});
	});

	/*点击收缩结果消失*/
	$('.search-item-content').on('tap',function(){
		$(".search-item-content").hide();
	});
	/*
	 点击轮播图片
	 */
	$('.mdui-slider-loop').on('tap','.mdui-slider-item',function(){
		$.openWin({
			name:'hos_main',
			animId : 2,
			url:'wgtroot://hospital/hos_main/ui/hos_main.html',
			pageParam:{
				cltpit01id:$(this).data('cltpit01id'),
				title:$(this).data('title'),
				address:$(this).data('address'),
				distance:$(this).data('distance'),
				time:$(this).data('time'),
				clthtp01013:$(this).data('clthtp01013'),
				focus:$(this).data('focus'),
				log:$(this).data('log'),
				lat:$(this).data('lat')
			}
		});
	});

	/*
	 * 搜索框
	 * */
	$('.search-box').on('tap','.search-img', doSearch);
    $('#search').on('input propertychange', doSearch);
    function doSearch() {
        var mc = $("#search").val();
        $('.search-before-content').show();
        if(mc){
            $.request({
                urlType: 'hos_queryAllHospital',
                data: {
                    "access_token": $.getStorage('access_token'),
                    clthtp01001 : mc
                }
            }, function (json) {
                if (json.success) {
                    $('.search-before-content').hide();
                    var html = '';
                    var len = json.data.length;
                    var data = json.data;
                    if(len==0){
                        html='<div class="search-item">暂无信息</div>';
                        $(".search-item-content").html(html).show();
                    }else{
                        for(var i=0;i<len;i++){
                            html+='<div id="'+i+'" class="search-item" data-focus="'+data[i].isfocus+'" data-id="'+data[i].clthtp01id+'" ' +
                                'data-clthtp01013="'+data[i].clthtp01013+ //医院等级
                                '" data-address="'+data[i].clthtp01006+ //医院地址
                                '" data-log="'+data[i].clthtp01004+ //医院地址
                                '" data-lat="'+data[i].clthtp01005+ //医院地址
                                '" data-distance="'+data[i].distance+ //医院距离
                                '" data-clthtp01011="'+data[i].clthtp01011+ //医院营业时间
                                '" data-tiaoshu="'+data[i].tiaoshu//评论条数
                                +'">'+data[i].clthtp01001+'</div>';
                        }
                        $(".search-item-content").html(html).show();
                    }
                }
                else {
                    alert('网络错误');
                }
            });
        }else{
            //$.toast("请输入搜索内容");
        }
    }
	/*
	 * 点击搜索结果跳转
	 * */
	$(document).on('tap','.search-item',function(){
		$(this).css("background-color","green");
		var cltpit01id = $(this).data("id");
		var clthtp01013 = $(this).data("clthtp01013");
		var address = $(this).data("address");
		var log = $(this).data('log');
		var lat = $(this).data('lat');
		var distance = $(this).data("distance")||'';
		var time = $(this).data("clthtp01011");
		var title = $(this).text();
		if(title == "暂无信息"){
			$(".search-item-content").hide();
			return;
		}
		$(".search-item-content").hide();
		$.openWin({
			name:'hos_main',
			animId : 2,
			url:'wgtroot://hospital/hos_main/ui/hos_main.html',
			pageParam:{
				cltpit01id:cltpit01id,
				title:title,
				address:address,
				distance:distance,
				clthtp01013:clthtp01013,
				time:time,
				focus:$(this).data("focus"),
				lat:lat,
				log:log
			}
		});
	});

	/*点击收缩结果消失*/
	$('.search-item-content').on('tap',function(){
		$(".search-item-content").hide();
	});

	//返回大首页
	$('.saoma').on('tap',function(){
		$.execScript({
			winName:'hos_list',
			script:'$.closeWin()'
		});
	});
</script>
</body>
</html>