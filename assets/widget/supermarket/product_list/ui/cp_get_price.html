<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>mCollection</title>
    <meta name="viewport" content="target-densitydpi=device-dpi,width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../../../static/mdui/css/mdui.min.css">
    <link rel="stylesheet" href="../../../static/mCheap/css/mCommon.css">
    <style>
        *{
            font-family: "Microsoft YaHei";
        }
        body{
            background-color: #E6EAE8;
            padding-top: 2.75rem;

        }
        .header-box{
            background-color: #F39426;
            padding: 0;
        }
        .header{
            width: 100%;
            height: 100%;
            position: relative;
        }
        .back{
            padding-right: 1rem;
            padding-left: 1rem;
            padding-top: 0.75rem;
            position: absolute;
            z-index: 100;
        }
        .back img{
            width:auto;
            height: 1.25rem;
        }
        .title{
            text-align: center;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            line-height: 2.75rem;
            color: #FFFFFF;
        }
        .content{
            height: 100%;
            width: 100%;
            overflow-y: auto;
            background-color: white;
        }
        .line-one{
            height: 4.5rem;
            padding: 1rem;
            position: relative;
        }
        .commentator-price{
            position: absolute;
            right: 5%;
            top: 35%;
            color: #3BA15C;
        }
        .commentator-num{
            color: #3BA15C;
        }
        .div-img{
            float: left;
        }
        .comment-list{
            border-bottom: 1px solid #B0B0B0;
        }
        .commentator{
            color: black;
            float: left;
            margin-left: 1rem;
            margin-top: 0.75rem;
        }
        .commentator-me{
            color: #3BA15C;
            float: left;
            margin-left: 1rem;
            margin-top: 0.75rem;
        }
        .head-img{
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 1.25rem;
        }
        .comment-detail{
            color:black;
            padding-left: 1rem;
        }
        .comment-time{
            font-size: 0.9rem;
            padding-top: 0.2rem;
            padding-left: 1rem;
            padding-bottom: 1rem;
        }
        .get-in{
            z-index: 2;
            font-weight: 600;
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 3rem;
            background-color: #F39426;
            color: white;
            line-height: 3rem;
            text-align: center;
        }
        .no-data{
            height: 3rem;
            text-align: center;
            line-height: 3rem;
            border-bottom: 1px solid #CCCCCC;
        }
        .mask{
            background-color:#CCCCCC;
            display: none;
            height:100%;
            width:100%;
            position:fixed;
            top:2.8rem;
            z-index:3;
        }
        .contents{
            height: 100%;
            background-color:#fff;
            z-index: 200;
            margin-top: 10rem;
            padding-bottom: 1rem;
        }
        .price-box{
            padding: 1rem;
            color: black;
        }
        #price-input{
            background-color: #F2F2F2;
            font-size: 1rem;
            width: 4.5rem;
            height: 2rem;
            margin-bottom: 0rem;
        }
        .input-box{
            padding: 0.5rem 0 0.5rem 0.5rem;
        }
        .pro-price{
            border-top: 1px solid #CCCCCC;
            border-bottom: 1px solid #CCCCCC;
            width: 100%;
            height: 3rem;
            background-color: white;
        }
        .unit{
            padding: 1rem 1rem 1rem 0;
            color: black;
        }
        .sure{
            z-index: 300;
            font-weight: 600;
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 3rem;
            background-color: #F39426;
            color: white;
            line-height: 3rem;
            text-align: center;
        }


        .img{
            z-index: 250;
            overflow-x:auto;
        }
        .person-img{
            width: 5rem;
            height: 6rem;
            border: 1px solid white;
            text-align: center;
        }
        .pic-img{
            width:5rem;
            height: 6rem;
        }
        .picture-box{
            height: 6rem;
        }
        .picture-box>img{
            width: 5rem;
            height: 100%;
            margin-left: 0.2rem;
            margin-right: 0.2rem;
        }
        .close-mc{
            float: right;
            margin-right: 1rem;
            margin-top: 1rem;
            color: white;
            padding: 0.25rem 0.5rem 0.25rem 0.5rem;
            border-radius: 1rem;
            border: 1px solid white;
        }

        /*上传中显示蒙层 -->*/
        .upload-mc{
            width:100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            position:fixed;
            z-index:999;
            display: none;
        }
        .progress_bars{
            width: 80%;
            height: 1rem;
            border-radius: 0.5rem;
            margin-left: 10%;
            margin-top: 5rem;
            border: 1px solid white;
        }
        .progress_bar{
            width: 0%;
            height: 1rem;
            border-radius: 0.5rem;
            background-color: red;
        }
        .progress{
            color: red;
            text-align:center;
            width: 100%;
            margin-top: 0.5rem;
        }
        .pictures-box>img{
            width: 5rem;
            height: 5rem;
            margin-left: 0.2rem;
            margin-right: 0.2rem;
        }
    </style>
</head>
<body>
<div class="upload-mc">
    <div class="progress_bars">
        <div class="progress_bar"></div>
    </div>
    <div class="progress">loading</div>
</div>

<div>
    <div class="header-box mdui-bar mdui-bar-nav">
        <div class="header">
            <div class="back mdui-action-back"><img src="../images/back.png"></div>
            <div class="title">公众报价</div>
        </div>
    </div>

    <!--评论-->
    <div class="mask">
        <div class="close-mc">close</div>
        <div class="contents">
            <div class="mdui-box pro-price">
                <div class="price-box mdui-box-flex-5">请输入价格：</div>
                <div class="input-box mdui-box-flex-1">
                    <input type="number" id="price-input"/>
                </div>
                <div class="unit mdui-box-flex-1">元</div>
            </div>
            <div class="img mdui-box">
                <div class="picture-box"></div>
                <div class="person-img">
                    <a href="#picture">
                        <img class="pic-img" src="../images/add_pic.png">
                    </a>
                </div>
            </div>
            <div class="sure">确&nbsp&nbsp&nbsp&nbsp定</div>
        </div>
    </div>

<!--    <div class="get-in">我要报价</div>-->
    <div class="get-in">我要报价</div>

    <div class="content" id="list">

        <!--<div class="comment-list">-->
            <!--<div class="line-one">-->
                <!--<div class="div-img"><img class="head-img" src="../image/t01f45d14a61adc12ab.jpg"/></div>-->
                <!--<div class="commentator">张笑笑</div>-->
            <!--</div>-->
            <!--<div class="comment-detail">报价: <span class="bj">35</span> 元</div>-->
            <!--<div class="pictures-box">-->
                <!--<img src="../images/add_pic.png">-->
                <!--<img src="../images/add_pic.png">-->
                <!--<img src="../images/add_pic.png">-->
                <!--<img src="../images/add_pic.png">-->
            <!--</div>-->
            <!--<div class="comment-time">2016-08-23 09:02</div>-->
        <!--</div>-->

    </div>

</div>

<!-- 点击照片显示蒙层 -->
<div id="picture" class="mdui-popover mdui-popover-action mdui-popover-bottom">
    <ul class="mdui-table-view"><!--菜单列表-->
        <li class="mdui-table-view-cell photo">
            <a href="#">拍照</a>
        </li>
        <li class="mdui-table-view-cell album">
            <a href="#">从相册选取</a>
        </li>
    </ul>
    <ul class="mdui-table-view">
        <li class="mdui-table-view-cell">
            <a href="#picture"><b>取消</b></a>
        </li>
    </ul>
</div>

<!--页面-->
<script src="../../../static/mdui/js/mdui.js"></script>
<script src="../../../static/mCheap/js/mCheap.config.js"></script>
<script src="../../../static/mCheap/js/scroll.js"></script>
<script src="../../../server.js"></script>
<script src="../../../public.js"></script>
<script>
    var obj={};//保存采集日期
    var pNum=1;//统计图片个数
    var pageNum=1;//分页的时候用的
    $.uexWindowReady(function(){
        //下拉加载更多
        var option = {id:"list",funs:{after:function(){
            pageNum=pageNum+1;
            getDataQueryUserPrice();
        }}};
        $.initScroll(option);

        getData();
        getDataQueryUserPrice();//获取报价信息

    });

    function getData(){
        var pageData=$.pageParam;
        var productData=$.strToJson(pageData);
        obj.proId=productData.proId;
        obj.proName=productData.proName;
        obj.marketName=productData.marketName;
        obj.lsh=productData.lsh;
    }



    //获取报价信息
    function getDataQueryUserPrice(){
        $.request({
            urlType:'supermarketqueryUserPrice',
            data:{
                access_token:$.getStorage('access_token'),
                cltpit01id:obj.lsh,
                epsprice01002:obj.proId,
                pageSize:'10',
                page:pageNum
            }
        },function(data){
            if(data.success){
                var lenG=data.data.assess.length;
                if(lenG){
                    setBaoJaData(data);
                }else{
                    if(pageNum==1){
                        setBaoJaData(data);
                    }else{
                        $.toast('没有更多了!');
                    }
                }
            }
        });
    }


    function setBaoJaData(data){
        var html='';
        var data_1=data.data.assess;
        var len=data_1.length;
        for(var i=0;i<len;i++){
            html +='<div class="comment-list">';
            html +=' <div class="line-one">';
            if(data.data.assess[i].userurl){
                html +=' <div class="div-img"><img class="head-img" src="'+$.serverSettings.serverPath+'/mobile/mcheap/mcheapAction!getComUserPicture.do?access_token=' + $.getStorage('access_token') + '&url=' + data.data.assess[i].userurl +'"/></div>';
            }else{
                html +=' <div class="div-img"><img class="head-img" src="../images/head.jpg"/></div>';
            }
            html +=' <div class="commentator">'+data_1[i].epsrtu01002+'</div>';
            html +='</div>';
            html +=' <div class="comment-detail">报价:'+data_1[i].epsprice01004+' 元</div>';
            html +='<div class="pictures-box">';
            var picLen=data_1[i].url.length;
            if(picLen){
                for(var x= 0;x<picLen;x++){
                    html +='<img src="'+$.serverSettings.serverPath+'/mobile/mcheap/mcheapAction!getUserPricePicture.do?access_token=' + $.getStorage('access_token') + '&url=' + data_1[i].url[x].epsprice02002 +'">';
                }
            }
            html +=' </div>';
            html +='  <div class="comment-time">'+data_1[i].create_time+'</div>';
            html +=' </div>';
        }
        $(".content").append(html);
    }

    //评论
    $(document).on('tap','.get-in',function(){
        $(".mask").show();
    });

    //点击确定
    $(".sure").on("tap",function(){
        var input=$("#price-input").val();
        if(input){
            addUserPrice(input);
        }else{
            alert("请输入价格");
        }
    });
    //新增超市产品报价
    function addUserPrice(input){
        $("#price-input").val("");
        $.request({
            urlType:'shopAddUserPrice',
            data:{
                access_token:$.getStorage('access_token'),
                cltpit01id:obj.lsh,    //超市流水号
                cltpit01001:obj.marketName,   //超市名称
                epsprice01004:input,  //用户报价
                epsprice01002:obj.proId,  //产品流水号
                epsprice01003:obj.proName   //产品名称
            }
        },function(data){
            if(data.success){
                var pic = $(".picture-box>img");
                var uploadlen=pic.length;
                var bz=data.data;
                if(uploadlen){
                    handleUploadFile(bz);
                    sendMsg(obj.marketName,obj.proName,input,'05');
                }else{
                    $.toast('报价成功!');
                    $(".mask").hide();
                    getDataQueryUserPrice();
                    sendMsg(obj.marketName,obj.proName,input,'05');
                }
            }else{
                $.toast("报价失败");
            }
        });
    }

    //报价完成后的成功回调
    function baojiaUploadSuccess(){
        $('.upload-mc').hide();
        $('.picture-box').html('');
        $.toast('图片上传完成');
        $('.mask').hide();
        pageNum=1;
        $('.content').html('');
        getDataQueryUserPrice();
    }


    /*
     拍照上传图片
     */
    /*拍照*/
    $(document).on('tap','.photo',function(){
        if(pNum<4){
            uexCamera.open(0,0);
            uexCamera.cbOpen=function(opId,dataType,data){
                var html='<img src="'+data+'">';
                $('.picture-box').append(html);
                pNum++;
            }
        }else{
            $.toast('亲！最多能上传三张图片！');
        }
    });

    /*从本地相册添加照片*/
    $(document).on('tap','.album',function(){
        if(pNum<4){
            uexImageBrowser.pick();
            uexImageBrowser.cbPick=function (opCode,dataType,data){
                var html='<img src="'+data+'">';
                $('.picture-box').append(html);
                pNum++;
            }
        }else{
            $.toast('亲！最多能上传三张图片！');
        }
    });
    //图片长按事件
    $(document).on('longtap','.picture-box>img',function(){
        $(this).remove();
        pNum--;
    });


    $(document).on('tap','.close-mc',function(){
        $('.mask').hide();
    });
    $(document).on('tap','.close-mc',function(){
        $('.mask').hide();
    });
    $('.person-img').on('tap',function(){
        $('#price-input').blur();
    });
</script>
</body>
</html>